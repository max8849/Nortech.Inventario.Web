<div class="page">
  <div class="top">
    <div class="titles">
      <h1>Informes</h1>
      <p class="muted">Resumen rápido para decidir.</p>
    </div>

    <div class="controls">
<mat-form-field appearance="outline" class="branch" *ngIf="isAdmin || branches.length > 1">
  <mat-label>Sucursal</mat-label>
  <mat-select [(ngModel)]="selectedBranchId" (selectionChange)="onBranchChange()">
    <mat-option *ngIf="isAdmin" [value]="0">Todas</mat-option>
    <mat-option *ngFor="let b of branches" [value]="b.id">{{ b.name }}</mat-option>
  </mat-select>
</mat-form-field>


      <mat-button-toggle-group [value]="days" (change)="setDays($event.value)" class="days">
        <mat-button-toggle [value]="7">7 días</mat-button-toggle>
        <mat-button-toggle [value]="30">30 días</mat-button-toggle>
        <mat-button-toggle [value]="90">90 días</mat-button-toggle>
      </mat-button-toggle-group>
    </div>
  </div>

  <div class="subline">
    <span class="chip" *ngIf="branchLabel">
      <mat-icon>store</mat-icon>
      {{ branchLabel }}
    </span>
  </div>

  <!-- Loading -->
  <div class="loading" *ngIf="loading">
    <mat-spinner diameter="30"></mat-spinner>
    <span>Cargando informes...</span>
  </div>

  <!-- Contenido (no render mientras loading para evitar brincos en móvil) -->
  <ng-container *ngIf="!loading">

    <!-- KPIs -->
    <ng-container *ngIf="overview as ov">
      <div class="kpis">
        <mat-card class="kpi" appearance="outlined">
          <div class="kpi-inner">
            <mat-icon>inventory_2</mat-icon>
            <div>
              <div class="kpi-value">{{ ov.activeProducts }}</div>
              <div class="kpi-label">Productos activos</div>
            </div>
          </div>
        </mat-card>

        <mat-card class="kpi danger" appearance="outlined">
          <div class="kpi-inner">
            <mat-icon>report</mat-icon>
            <div>
              <div class="kpi-value">{{ ov.lowStockCount }}</div>
              <div class="kpi-label">Sin stock</div>
            </div>
          </div>
        </mat-card>

        <mat-card class="kpi" appearance="outlined">
          <div class="kpi-inner">
            <mat-icon>swap_horiz</mat-icon>
            <div>
              <div class="kpi-value">{{ ov.movementsCount }}</div>
              <div class="kpi-label">Movimientos ({{ days }} días)</div>
            </div>
          </div>
        </mat-card>

        <mat-card class="kpi" appearance="outlined">
          <div class="kpi-inner">
            <mat-icon>format_list_bulleted</mat-icon>
            <div>
              <div class="kpi-value">{{ ov.movementItemsCount }}</div>
              <div class="kpi-label">Renglones movidos</div>
            </div>
          </div>
        </mat-card>
      </div>

      <mat-divider></mat-divider>
    </ng-container>

    <!-- Charts -->
    <ng-container *ngIf="daily">
      <div class="charts">
        <mat-card class="chart-card" appearance="outlined">
          <div class="chart-head">
            <div>
              <div class="chart-title">Entradas vs Salidas</div>
              <div class="muted">Por día ({{ days }} días)</div>
            </div>
            <mat-icon class="hint">show_chart</mat-icon>
          </div>

          <div class="chart-wrap">
            <canvas #lineCanvas></canvas>
          </div>
        </mat-card>

        <mat-card class="chart-card" appearance="outlined">
          <div class="chart-head">
            <div>
              <div class="chart-title">Top 10 productos más movidos</div>
              <div class="muted">Volumen total ({{ days }} días)</div>
            </div>
            <mat-icon class="hint">bar_chart</mat-icon>
          </div>

          <div class="chart-wrap">
            <canvas #barCanvas></canvas>
          </div>
        </mat-card>
      </div>
    </ng-container>

    <!-- Empty -->
    <div class="empty" *ngIf="!overview && !daily">
      No hay datos para mostrar todavía.
    </div>
  </ng-container>
</div>
