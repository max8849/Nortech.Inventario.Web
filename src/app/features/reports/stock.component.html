<div class="page">

  <!-- ===== Controles ===== -->
<div class="toolbar">
    <!-- Row 1: filtros -->
    <div class="toolbar-row filters">
      <mat-form-field appearance="outline" class="search">
        <mat-label>Buscar producto</mat-label>
        <input matInput [(ngModel)]="q" (input)="applyFilter()" />
      </mat-form-field>

      <mat-form-field
        *ngIf="isAdmin || branches.length > 1"
        appearance="outline"
        class="branch"
      >
        <mat-label>Sucursal</mat-label>
        <mat-select [(ngModel)]="selectedBranchId" (selectionChange)="onBranchChange()">
          <mat-option *ngIf="isAdmin" [value]="0">Todas</mat-option>
          <mat-option *ngFor="let b of branches" [value]="b.id">
            {{ b.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Row 2: acciones -->
    <div class="toolbar-row actions">
      <button mat-raised-button type="button" (click)="load()" [disabled]="loading">
        <mat-icon>refresh</mat-icon>
        Recargar
      </button>

      <button
        mat-raised-button
        color="primary"
        type="button"
        [disabled]="loading"
        [routerLink]="['/movements/movement-quick']"
      >
        <mat-icon>swap_horiz</mat-icon>
        Registrar entrada / salida
      </button>

      <button
        mat-stroked-button
        type="button"
        (click)="exportExcel()"
        [disabled]="loading || filtered.length === 0"
      >
        <mat-icon>file_download</mat-icon>
        Exportar a Excel
      </button>

      <button
        *ngIf="isAdmin"
        mat-stroked-button
        type="button"
        [routerLink]="['/products/new']"
        [disabled]="loading"
      >
        <mat-icon>add</mat-icon>
        Agregar producto
      </button>

      <div *ngIf="loading" class="loading-inline">
        <mat-spinner diameter="22"></mat-spinner>
        <span>Cargando...</span>
      </div>
    </div>
  </div>

  <!-- ===== Desktop/Tablet: Tabla ===== -->
  <div class="table-wrap" *ngIf="!loading">
    <table
      mat-table
      [dataSource]="dataSource"
      matSort
      class="stock-table mat-elevation-z2"
      *ngIf="filtered.length > 0"
    >
      <!-- Sucursal (solo cuando Admin y Todas) -->
      <ng-container matColumnDef="branch">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="th">Sucursal</th>
        <td mat-cell *matCellDef="let r">{{ r.branchName || '' }}</td>
      </ng-container>

      <!-- âœ… Sin SKU -->

      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="th">Producto</th>
        <td mat-cell *matCellDef="let r" class="cell-name">
          {{ r.name }}
        </td>
      </ng-container>

      <ng-container matColumnDef="unit">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="th">Unidad</th>
        <td mat-cell *matCellDef="let r">{{ r.unit }}</td>
      </ng-container>

      <ng-container matColumnDef="stock">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="th">Stock</th>
        <td mat-cell *matCellDef="let r" class="cell-stock">
          {{ r.stock }}
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef class="th">Estado</th>
        <td mat-cell *matCellDef="let r">
          <span
            class="chip"
            [class.chip-ok]="(r.stock ?? 0) > 0"
            [class.chip-bad]="(r.stock ?? 0) <= 0"
          >
            {{ (r.stock ?? 0) <= 0 ? 'SIN STOCK' : 'OK' }}
          </span>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns" class="header-row"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="data-row"></tr>
    </table>

    <div *ngIf="filtered.length === 0" class="empty">
      No hay datos.
    </div>
  </div>

  <!-- ===== Mobile: Cards ===== -->
  <div class="mobile-cards" *ngIf="!loading && filtered.length > 0">
    <div class="card-row" *ngFor="let r of filtered">
      <div class="card-top">
        <div class="title">{{ r.name }}</div>

        <span
          class="chip"
          [class.chip-ok]="(r.stock ?? 0) > 0"
          [class.chip-bad]="(r.stock ?? 0) <= 0"
        >
          {{ (r.stock ?? 0) <= 0 ? 'SIN STOCK' : 'OK' }}
        </span>
      </div>

      <div class="meta">
        <div class="kv">
          <span class="k">Unidad</span>
          <span class="v">{{ r.unit }}</span>
        </div>

        <div class="kv">
          <span class="k">Stock</span>
          <span class="v">{{ r.stock }}</span>
        </div>

        <div class="kv" *ngIf="isAdmin && selectedBranchId === 0">
          <span class="k">Sucursal</span>
          <span class="v">{{ r.branchName || '' }}</span>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!loading && filtered.length === 0" class="empty">
    No hay datos.
  </div>

</div>
