<div style="display:flex; gap:12px; align-items:center; margin-bottom: 12px; flex-wrap: wrap;">
  <mat-form-field appearance="outline" style="width: 380px; max-width: 100%;">
    <mat-label>Buscar producto</mat-label>
    <input matInput [(ngModel)]="q" (input)="applyFilter()" placeholder="SKU, nombre o sucursal" />
  </mat-form-field>

  <!-- ✅ Admin: selector de sucursal -->
  <mat-form-field *ngIf="isAdmin" appearance="outline" style="width: 220px; max-width: 100%;">
    <mat-label>Sucursal</mat-label>
    <mat-select [(ngModel)]="selectedBranchId" (selectionChange)="onBranchChange()">
      <mat-option [value]="0">Todas</mat-option>
      <mat-option *ngFor="let b of branches" [value]="b.id">
        {{ b.name }}
      </mat-option>
    </mat-select>
  </mat-form-field>

  <button mat-raised-button type="button" (click)="load()" [disabled]="loading">
    <mat-icon>refresh</mat-icon>
    Recargar
  </button>

  <button
    mat-raised-button
    color="primary"
    type="button"
    [disabled]="loading"
    [routerLink]="['/movements/movement-quick']"
  >
    <mat-icon>swap_horiz</mat-icon>
    Registrar entrada / salida
  </button>

<button
  mat-stroked-button
  type="button"
  (click)="exportExcel()"
  [disabled]="loading || filtered.length === 0"
>
  <mat-icon>file_download</mat-icon>
  Exportar a Excel
</button>

<button
  mat-stroked-button
  type="button"
  [routerLink]="['/products/new']"
  [disabled]="loading"
>
  <mat-icon>add</mat-icon>
  Agregar producto
</button>




  <div *ngIf="loading" style="display:flex; align-items:center; gap:10px;">
    <mat-spinner diameter="22"></mat-spinner>
    <span>Cargando...</span>
  </div>
</div>

<table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2" *ngIf="!loading">

  <ng-container matColumnDef="branch">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Sucursal</th>
    <td mat-cell *matCellDef="let r">{{ r.branchName || '' }}</td>
  </ng-container>

  <ng-container matColumnDef="sku">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>SKU</th>
    <td mat-cell *matCellDef="let r">{{ r.sku }}</td>
  </ng-container>

  <ng-container matColumnDef="name">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Producto</th>
    <td mat-cell *matCellDef="let r">{{ r.name }}</td>
  </ng-container>

  <ng-container matColumnDef="unit">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Unidad</th>
    <td mat-cell *matCellDef="let r">{{ r.unit }}</td>
  </ng-container>

  <ng-container matColumnDef="stock">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Stock</th>
    <td mat-cell *matCellDef="let r">{{ r.stock }}</td>
  </ng-container>

  <ng-container matColumnDef="minStock">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Mínimo</th>
    <td mat-cell *matCellDef="let r">{{ r.minStock }}</td>
  </ng-container>

  <ng-container matColumnDef="status">
    <th mat-header-cell *matHeaderCellDef>Estado</th>
    <td mat-cell *matCellDef="let r">
      <span [class.low]="r.isLow">{{ r.isLow ? 'BAJO' : 'OK' }}</span>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
  <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
</table>


<div *ngIf="!loading && filtered.length === 0">
  No hay datos.
</div>
